<script type="text/javascript">
  var encodings = [
    [ "writeFile.encoding.native",
      "utf8",
      "ucs2",
      "utf-16le",
      "ascii",
      "binary",
      "base64",
      "hex"
    ],
    [ "writeFile.encoding.unicode",
      "utf-16be",
    ],
    [ "writeFile.encoding.japanese",
      "Shift_JIS",
      "Windows-31j",
      "Windows932",
      "EUC-JP"
    ],
    [ "writeFile.encoding.chinese",
      "GB2312",
      "GBK",
      "GB18030",
      "Windows936",
      "EUC-CN"
    ],
    [ "writeFile.encoding.korean",
      "KS_C_5601",
      "Windows949",
      "EUC-KR"
    ],
    [ "writeFile.encoding.taiwan",
      "Big5",
      "Big5-HKSCS",
      "Windows950"
    ],
    [ "writeFile.encoding.windows",
      "cp874",
      "cp1250",
      "cp1251",
      "cp1252",
      "cp1253",
      "cp1254",
      "cp1255",
      "cp1256",
      "cp1257",
      "cp1258"
    ],
    [ "writeFile.encoding.iso",
      "ISO-8859-1",
      "ISO-8859-2",
      "ISO-8859-3",
      "ISO-8859-4",
      "ISO-8859-5",
      "ISO-8859-6",
      "ISO-8859-7",
      "ISO-8859-8",
      "ISO-8859-9",
      "ISO-8859-10",
      "ISO-8859-11",
      "ISO-8859-12",
      "ISO-8859-13",
      "ISO-8859-14",
      "ISO-8859-15",
      "ISO-8859-16"
    ],
    [ "writeFile.encoding.ibm",
      "cp437",
      "cp737",
      "cp775",
      "cp808",
      "cp850",
      "cp852",
      "cp855",
      "cp856",
      "cp857",
      "cp858",
      "cp860",
      "cp861",
      "cp866",
      "cp869",
      "cp922",
      "cp1046",
      "cp1124",
      "cp1125",
      "cp1129",
      "cp1133",
      "cp1161",
      "cp1162",
      "cp1163"
    ],
    [ "writeFile.encoding.mac",
      "maccroatian",
      "maccyrillic",
      "macgreek",
      "maciceland",
      "macroman",
      "macromania",
      "macthai",
      "macturkish",
      "macukraine",
      "maccenteuro",
      "macintosh"
    ],
    [ "writeFile.encoding.koi8",
      "koi8-r",
      "koi8-u",
      "koi8-ru",
      "koi8-t"
    ],
    [ "writeFile.encoding.misc",
      "armscii8",
      "rk1048",
      "tcvn",
      "georgianacademy",
      "georgianps",
      "pt154",
      "viscii",
      "iso646cn",
      "iso646jp",
      "hproman8",
      "tis620"
    ]
  ];

  RED.nodes.registerType('Write File', {
    category: 'storage',
    color: '#7d7d5c',
    credentials: {
    },
    defaults: {
      name: {
        value: ''
      },
      filename: {
        value: '',
        validate: RED.validators.typedInput({ typeField: 'filenameType' })
      },
      filenameType: {
        value: 'str'
      },
      overwrite: {
        value: false,
        required: true
      },
      encoding: {
        value: 'none'
      },
      autoCreateDir: {
        value: false,
        required: true
      },
      appendNewLine: {
        value: false,
        required: true
      },
    },
    inputs: 1,
    outputs: 1,
    icon: 'file-out.svg',
    label: function () {
      return this.name || this.filename || 'Write File';
    },
    oneditprepare: function () {
      let node = this;

      // Filename input
      $("#node-input-filename").typedInput({
        default: "str",
        types: [
          {
            label: node._("writeFile.label.path"),
            value: "str",
            icon: ""
          },
          "msg",
          "env"
        ],
        typeField: $("#node-input-filenameType")
      });

      if(typeof node.filenameType == 'undefined') {
        //existing node AND filenameType is not set - inplace (compatible) upgrade to new typedInput
        if(node.filename == "") { //was using empty value to denote msg.filename - set typedInput to match
          node.filename = "filename";
          node.filenameType = "msg";
          $("#node-input-filename").typedInput("type", node.filenameType);
          $("#node-input-filename").typedInput("value", node.filename);
        } else if(/^\${[^}]+}$/.test(node.filename)) { //was using an ${ENV_VAR}
          node.filenameType = "env";
          node.filename = node.filename.replace(/\${([^}]+)}/g, function(match, name) {
            return (name === undefined)?"":name;
          });
          $("#node-input-filename").typedInput("type", node.filenameType);
          $("#node-input-filename").typedInput("value", node.filename);
        } else { //was using a static filename - set typedInput type to str
          node.filenameType = "str";
          $("#node-input-filename").typedInput("type", node.filenameType);
          $("#node-input-filename").typedInput("value", node.filename);
        }
      }

      // Encoding input
      var encSel = $("#node-input-encoding");
      var label = node._("writeFile.encoding.none");
      $("<option/>", {
        value: "none",
        label: label
      }).text(label).appendTo(encSel);
      $("<option/>", {
        value: "setbymsg",
        label: node._("writeFile.encoding.setbymsg")
      }).text(label).appendTo(encSel);

      encodings.forEach(function(item) {
        if(Array.isArray(item)) {
          var group = $("<optgroup/>", {
            label: node._(item[0])
          }).appendTo(encSel);
          for (var i = 1; i < item.length; i++) {
            var enc = item[i];
            $("<option/>", {
              value: enc,
              label: enc
            }).text(enc).appendTo(group);
          }
        }
        else {
          $("<option/>", {
            value: item,
            label: item
          }).text(item).appendTo(encSel);
        }
      });
      encSel.val(node.encoding);
    },
    oneditsave: function () {
    },
    oneditcancel: function () {
    },
  });
</script>

<script type="text/x-red" data-template-name="Write File">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-stack-exchange"></i> <span data-i18n="writeFile.label.name"></span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
     <label for="node-input-filename"><i class="fa fa-file"></i> <span data-i18n="writeFile.label.filename"></span></label>
     <input id="node-input-filename" type="text">
     <input type="hidden" id="node-input-filenameType">
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-overwrite" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-input-overwrite" style="width: 70%"><span data-i18n="writeFile.label.overwrite"></span></label>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-autoCreateDir" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-input-autoCreateDir" style="width: 70%"><span data-i18n="writeFile.label.autoCreateDir"></span></label>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-appendNewLine" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-input-appendNewLine" style="width: 70%"><span data-i18n="writeFile.label.appendNewLine"></span></label>

  <div class="form-row form-row-file-encoding">
    <label for="node-input-encoding"><i class="fa fa-flag"></i> <span data-i18n="writeFile.label.encoding"></span></label>
    <select type="text" id="node-input-encoding" style="width: 250px;">
    </select>
  </div>
</script>

<script type="text/html" data-help-name="Write File">
<p>The Write File node writes data to a file on the file system. It supports various file encodings and provides options for file handling, directory creation, and data formatting.</p>

<h3>Configuration</h3>

<h4>Basic Settings</h4>
<ul>
    <li><b>Name</b>: Node name that will be displayed in the flow.</li>
    <li><b>Filename</b>: Path to the file to be written. Can be a static path, a value from <code>msg.filename</code>, or an environment variable.</li>
    <li><b>Encoding</b>: Character encoding for the file. Choose from a wide range of encodings or use the default system encoding.</li>
</ul>

<h4>File Handling Options</h4>
<ul>
    <li><b>Overwrite File</b>: When enabled, the entire file content will be replaced with new data. When disabled, new data will be appended to the existing file.</li>
    <li><b>Auto-Create Folder</b>: Automatically creates the directory structure if it doesn't exist.</li>
    <li><b>Add Newline (\n) After Write</b>: Automatically appends a newline character after each write operation.</li>
</ul>

<h3>Inputs</h3>
<dl class="message-properties">
    <dt>msg.payload <span class="property-type">string | buffer | object | boolean | number</span></dt>
    <dd>The data to be written to the file. Objects will be converted to JSON strings, and boolean/number values will be converted to strings.</dd>
    <dt>msg.filename <span class="property-type">string</span></dt>
    <dd>If the filename type is set to <code>msg</code>, the node will write to the file specified in this property.</dd>
    <dt>msg.payload.filename <span class="property-type">string</span></dt>
    <dd>Alternative location for the filename if <code>msg.filename</code> is not provided.</dd>
    <dt>msg.env <span class="property-type">object</span></dt>
    <dd>If the filename type is set to <code>env</code>, the node will use this environment variable map.</dd>
</dl>

<h3>Outputs</h3>
<dl class="message-properties">
    <dt>msg <span class="property-type">object</span></dt>
    <dd>The original message is passed through unchanged after successful file write operation.</dd>
</dl>

<h3>Details</h3>
<p>The Write File node provides efficient file writing capabilities with multiple configuration options:</p>

<h4>Data Type Handling</h4>
<ul>
    <li><b>String/Buffer</b>: Written directly to the file</li>
    <li><b>Objects</b>: Automatically converted to JSON format</li>
    <li><b>Boolean/Number</b>: Converted to string representation</li>
</ul>

<h4>File Modes</h4>
<ul>
    <li><b>Overwrite Mode</b>: Replaces the entire file content (equivalent to 'w' flag)</li>
    <li><b>Append Mode</b>: Adds new content to the end of existing file (equivalent to 'a' flag)</li>
</ul>

<h4>Stream Management</h4>
<p>The node uses intelligent stream management to optimize performance:</p>
<ul>
    <li>File streams are kept open for 3 seconds after the last write operation</li>
    <li>Multiple writes to the same file reuse the existing stream</li>
    <li>Streams are automatically closed when the node is stopped or after timeout</li>
</ul>

<h4>Error Handling</h4>
<p>The node will generate errors in the following situations:</p>
<ul>
    <li>No filename is specified</li>
    <li>Target directory doesn't exist (when auto-create is disabled)</li>
    <li>Target path points to a directory instead of a file</li>
    <li>File system permissions prevent writing</li>
</ul>

<h3>Example</h3>
<pre>[{"id":"48d6979c28b72153","type":"inject","z":"c781ad444e961c1f","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Hello World","payloadType":"str","x":250,"y":780,"wires":[["01fb1b73372b0c58"]]},
{"id":"01fb1b73372b0c58","type":"Write File","z":"c781ad444e961c1f","name":"","filename":"logs/output.txt","filenameType":"str","overwrite":false,"encoding":"utf8","autoCreateDir":true,"appendNewLine":true,"x":480,"y":780,"wires":[["7a57571edfa5cc70"]]},
{"id":"7a57571edfa5cc70","type":"debug","z":"c781ad444e961c1f","name":"Write Complete","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":760,"y":800,"wires":[]}]</pre>
<p>This example demonstrates writing text data to a file with automatic directory creation and newline appending. Each message payload will be appended to the file as a new line.</p>

<h3>Tips</h3>
<ul>
    <li>Use append mode for logging scenarios where you want to preserve existing content</li>
    <li>Enable auto-create folder to avoid manual directory setup</li>
    <li>For structured data, consider using JSON encoding or formatting the payload before writing</li>
    <li>Monitor file system space when writing large amounts of data</li>
</ul>
</script>
